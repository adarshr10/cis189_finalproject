# Overview
In this project we have included a notebook that can hopefully help hospitals of most sizes generate schedules for their nurses quickly
and without assumptions on patient schedules. We've added several constraints to ensure that nurse workloads are balanced and that nurses
are not overworked by many double shifts and having to serve lots of patients. This came at the expense of limiting patient-nurse acuity and unfortunately, this is an inherent problem in nurse scheduling that our model attempts to address in the best way possible.

To model the problem we used the google or-tools CP model. While we could have used mixed-integer programming, the built in functions and reification offered by the CP model made it much easier to add the constraints we needed to make a robust model. We also initally ran into trouble finding real world data for this problem as much of it is not public. While we did find one dataset with small samples, these were not enough to model real large hospital settings and thus made it difficult to see if our model could scale up. Thus, we had to do some research on things like nurse:patient ratios at most hospitals, types of patients admitted to hospitals, etc. in order to generate data that was as close to real as possible. With more time and access to more information on hospital systems, we probably could build an even more robust data generation model.

We encoded several baseline constraints into the model such as bounding the number of patients to each nurse, ensuring each patient is getting served, etc. The main two constraints were to ensure that standard deviation of patients per nurse was low and that we penalized assigning back to back shifts for nurses. For the latter, it involved the use of reification since we needed to only penalize if we saw back to back shifts. We first attempted to model this as a hard constraint, using the 'at most one' constraint modeling we learned all the way back in lecture one. However, this proved to be too hard of a constraint for the model to meet most times. With a 7:1 patient:nurse ratio and only 10 hours in a day, it is sometimes impossible to meet this constraint while serving all the patients. We found that this can be resolved by increasing the hours worked per nurse to 17 , but this goes against our thesis of reducing nurse workload. We could also get a lucky random patient arrival schedule (i.e. on where many patients don't arrive in consecutive hours and are instead equally spaced), but this again is not something we want to code into the model. Thus, we decided on making the double shifts a soft constraint and penalized the model for assigning lots of back-to-back shifts. Note that we left the 'hard' constraint in since it is was interesting to code up.

Finally, when optimizing our model, we had to some how optimize based on 3 different parameters: the standard deviation between nurse workloads, the acuity score, and back-to-back penalty. Since we wanted to maximize the acuity score, we just decided to minimize the sum of all three, taking the negative of the acuity score. Another issue we had was that there was a co-dependence between the acuity score and standard deviation/penalty. To resolve this, we scaled these two parameters in a similar manner to what we did in class: the difference between the max and min value of acuity score. This proved to work really well for us. Since the acuity score can be much larger than the variance in nurse workloads, without this change in objective we found that our model would often seek for the best acuity score and disregard the reasonable and healthy nurse schedules. With the technique from class we can pretty consistently get 0 to 2 hour differences in hours worked between nurses, as oppose to 3 to 4 hour differences.

# File Structure
In `/data`, you can find several open-source data files that we found online and used initially to help create our model. The `README.txt` in this folder has a schema for this data. `hospital_data.txt` contains the data sets generated by our data generator function.

In `generate_data.py`, you can find the code for generating a data set, given an initial number of nurses. 

Finally in ```nurse_balancing.ipynb``` you can find the notebook that will use the data in ```data/hospital_data.txt``` to generate a nurse schedule. It contains all the constraints we used and the scheduler is built as a class. 

# Instructions
To generate a new data set of a new size, simply run the following on the command line:
```
python generate_data.py {number of nurses}
``` 
Note that subsequent generations of data will replace old datasets so save the old data if you want it!

Once a dataset of your choosing is made, just run all the cells above the **STOP HERE** cell in the notebook. It will output the average acuity score of the nurses and the 10-hour schedule for each nurse. Check the `RESULTS.md` page for a note on what is below the **STOP HERE**.

You will need ```ortools.sat.python``` and ```numpy``` to run the notebook and data generation file.



